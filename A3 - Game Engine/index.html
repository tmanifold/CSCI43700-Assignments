<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <title>Game Engine Demo</title>

        <script type="text/javascript" src="./js/engine.js"></script>
        <script type="text/javascript" src="./js/utility.js"></script>

        <script type="text/javascript">

            class Projectile extends Sprite {
                constructor(scene, source) {
                    super('./img/livestock/cow side.png', scene);

                    this.setBoundAction(Sprite.BOUND_ACTION.DESTROY);

                    this.height = 20;
                    this.width = 20;

                    this.translate(source.x, source.y);

                    // get a unit vector from the source image angle and scale it appropriately
                    this.vel = Vector2.fromPolar(1, Angle.toRadians(source.imageAngle));
                    this.vel.scaleBy(source._projectileSpeed);
                }

                update() {
                    super.update();
                }
            }

            class Cow extends Sprite{
                constructor(scene) {
                    super('./img/livestock/cow side.png', scene, 32, 32, scene.width / 2, scene.height / 2);
                    this._MAX_HITS = 5;
                    this._hits = 0;

                    this._kb = scene.kb;
                    this._rotateAmount = 10;

                    this._projectiles = [];

                    this._canFire = true;
                    this._lastShot = 0;
                    this._fireRate = 100;
                    this._projectileSpeed = 10;

                    this._lastHit = 0;
                    this._invtime = 1000;
                    this._invuln = false;
                }

                checkKeys() {
                    if (this._kb.keys['w']) {
                        this.addForce(new Vector2(0, -1));
                    }

                    if (this._kb.keys['a']) {
                        this.addForce(new Vector2(-1, 0));
                    }

                    if (this._kb.keys['s']) {
                        this.addForce(new Vector2(0, 1));
                    }

                    if (this._kb.keys['d']) {
                        this.addForce(new Vector2(1, 0));
                    }

                    if (this._kb.keys['ArrowLeft']) {
                        this.rotateImageAngle(-this._rotateAmount);
                    }

                    if (this._kb.keys['ArrowRight']) {
                        this.rotateImageAngle(this._rotateAmount);
                    }

                    if (this._kb.keys['ArrowUp']) {
                        this.fire();
                    }
                }

                fire() {
                    if (this._canFire)  {
                        new Projectile(scene, this);
                        this._canFire = false;

                        this._lastShot = Date.now();
                    }
                }

                // process getting hit
                getHit() {
                    this._hits++;
                    this._invuln = true;
                    this._lastHit = Date.now();
                }

                shotTimer() {
                    if (this._lastShot + this._fireRate < Date.now()) {
                        this._canFire = true;
                    }
                }

                iframesTimer() {
                    if (this._lastHit + this._invtime > Date.now()) {
                        this._invuln = false;
                    }
                }

                update() {
                    super.update();
                    this.checkKeys();
                    this.shotTimer();
                }
            }

            class Burger extends Sprite {
                constructor(scene, cow) {
                    super('./img/burger.png', scene, 50, 50, getRandomInt(scene.width), getRandomInt(scene.height));

                    const VMAX = 10;

                    this._thecow = cow;

                    this._dx = getRandomInt(VMAX);
                    this._dy = getRandomInt(VMAX);

                    this.addForce(new Vector2(this._dx, this._dy));
                }

                update() {
                    super.update();
                    // first check if we hit the cow
                    if (!this._thecow._invuln) {
                        if (this.collidesWith(this._thecow)) {
                            this._thecow.getHit();

                            this.destroy();
                        }
                    }

                    for (const p of this._thecow._projectiles) {
                        if (this.collidesWith(p)) {
                            this.destroy();
                            p.destroy();
                        }
                    }

                }
            }

            class Sheep extends Sprite {
                constructor(scene) {
                    super('./img/livestock/sheep side.png', scene, 30, 30, getRandomInt(scene.width), getRandomInt(scene.height));

                    const VMAX = 10;

                    this._dx = getRandomInt(VMAX);
                    this._dy = getRandomInt(VMAX);

                    this.addForce(new Vector2(this._dx, this._dy));
                }

                update() {
                    super.update();
                }
            }

            // get rand int in range with negative
            // https://stackoverflow.com/a/13455101
            function getRandomInt(max) {
                return Math.ceil(Math.random() * max) * (Math.round(Math.random()) ? 1 : -1);
            }

            // Game initialization
            function init() {

                setDebugMode(DEBUG.ON);

                scene = new Scene('BovineFury');
                scene.setBorder('1px solid gray');

                scene.start();

                Cow = new Cow(scene);
            }

            // Main game loop
            function update() {
                scene.clear();

                for (const sprite of scene.sprites) {
                    sprite.update();
                }
            }

        </script>
    </head>

    <body onload="init()">

        <h3>Bovine Fury</h3>

        <div id="demo" style="padding:10px;"></div>

    </body>

</html>
